<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Strike News Chart</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #controls {
            display: flex;
            align-items: center;
            margin-top: 20px;
            margin-bottom: 20px;
            font-size: 20px;
        }

        #intervalSelect {
            margin-left: 10px;
            font-size: 20px;
        }

        #filters {
            margin-top: 20px;
        }

        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .filter-item {
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
        }

        .flag {
            font-size: 20px;
        }

        .filter-item.active {
            background-color: #ccc;
        }
    </style>
</head>
<body>
<h1>График мировых новостей о забастовках</h1>
<div id="controls">
    <label for="intervalSelect">Интервал:</label>
    <select id="intervalSelect">
        <option value="day">Дни</option>
        <option value="week" selected>Недели</option>
        <option value="month">Месяцы</option>
    </select>
</div>
<canvas id="strikeChart" width="800" height="200"></canvas>

<div id="filters">
    <div id="countryFilters" class="filter-container"></div>
    <div id="professionFilters" class="filter-container"></div>
</div>

<script>
    function getPastDatesUrls(startDate, count) {
        const urls = [];
        let date = new Date(startDate);
        for (let i = 0; i < count; i++) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const url = `https://raw.githubusercontent.com/lmmanueI/newworkerstimes/github-pages/data/strikes_news/${year}/${month}.json`;
            urls.push(url);
            date.setMonth(date.getMonth() - 1);
        }
        return urls;
    }

    async function fetchDataFromUrls(urls) {
        const allData = [];
        for (const url of urls) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    allData.push(...data);
                } else {
                    break; // Stop fetching if a file does not exist
                }
            } catch (error) {
                break; // Stop fetching if a file does not exist
            }
        }
        return allData;
    }

    function initFilters(data) {
        const countries = [...new Set(data.map(d => d.country))];
        const professions = [...new Set(data.map(d => d.who))];

        const countryFilters = document.getElementById('countryFilters');
        const professionFilters = document.getElementById('professionFilters');

        countries.forEach(country => {
            const filterItem = document.createElement('div');
            filterItem.className = 'filter-item flag';
            filterItem.textContent = country;
            filterItem.dataset.value = country;
            countryFilters.appendChild(filterItem);
        });

        professions.forEach(profession => {
            const filterItem = document.createElement('div');
            filterItem.className = 'filter-item';
            filterItem.textContent = profession;
            filterItem.dataset.value = profession;
            professionFilters.appendChild(filterItem);
        });

        document.querySelectorAll('.filter-item').forEach(item => {
            item.addEventListener('click', toggleFilterItem);
        });
    }

    function parseDate(dateString) {
        const parsedDate = d3.timeParse("%Y-%m-%d %H:%M:%S.%f")(dateString);
        if (!parsedDate) {
            console.error('Error parsing date:', dateString);
        }
        return parsedDate;
    }

    function formatDate(date, interval) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        if (interval === 'month') {
            const lastDayOfMonth = new Date(year, date.getMonth() + 1, 0); // Get last day of the month
            return `${lastDayOfMonth.getFullYear()}-${String(lastDayOfMonth.getMonth() + 1).padStart(2, '0')}-${String(lastDayOfMonth.getDate()).padStart(2, '0')}`;
        } else if (interval === 'week') {
            const weekEnd = d3.timeSunday(date);
            const lastDayOfWeek = new Date(weekEnd.getFullYear(), weekEnd.getMonth(), weekEnd.getDate() + 7);
            return `${lastDayOfWeek.getFullYear()}-${String(lastDayOfWeek.getMonth() + 1).padStart(2, '0')}-${String(lastDayOfWeek.getDate()).padStart(2, '0')}`;
        } else {
            return `${year}-${month}-${day}`;
        }
    }

    function getUniqueEvents(data) {
        const uniqueEvents = new Map();
        data.forEach(d => {
            const date = parseDate(d.created);
            const key = `${d.country}-${d.who}-${formatDate(date, 'day')}`;
            if (!uniqueEvents.has(key)) {
                uniqueEvents.set(key, d);
            }
        });
        return Array.from(uniqueEvents.values());
    }

    function updateChart(data) {
        const selectedCountries = Array.from(document.querySelectorAll('#countryFilters .filter-item.active')).map(item => item.dataset.value);
        const selectedProfessions = Array.from(document.querySelectorAll('#professionFilters .filter-item.active')).map(item => item.dataset.value);
        const interval = document.getElementById('intervalSelect').value;

        const filteredData = data.filter(d =>
            (selectedCountries.length === 0 || selectedCountries.includes(d.country)) &&
            (selectedProfessions.length === 0 || selectedProfessions.includes(d.who))
        );

        const uniqueEvents = getUniqueEvents(filteredData);

        const newsByDate = d3.rollup(
            uniqueEvents,
            v => v.length,
            d => {
                const date = parseDate(d.created);
                return date ? formatDate(date, interval) : null;
            }
        );

        // Filter out invalid dates (null values)
        const sortedNewsByDate = Array.from(newsByDate)
            .filter(d => d[0] !== null)
            .sort((a, b) => new Date(a[0]) - new Date(b[0]));

        // Collecting tooltip information
        const tooltipData = new Map();
        uniqueEvents.forEach(d => {
            const date = parseDate(d.created);
            const formattedDate = formatDate(date, interval);
            if (!tooltipData.has(formattedDate)) {
                tooltipData.set(formattedDate, []);
            }
            tooltipData.get(formattedDate).push(`${d.country}: ${d.who}`);
        });

        // Sorting tooltip information
        tooltipData.forEach((value, key) => {
            value.sort();
        });

        strikeChart.data.labels = sortedNewsByDate.map(d => new Date(d[0]));
        strikeChart.data.datasets[0].data = sortedNewsByDate.map(d => d[1]);

        strikeChart.options.plugins.tooltip.callbacks.label = function (context) {
            const date = context.label;
            const formattedDate = formatDate(new Date(date), interval);
            const events = tooltipData.get(formattedDate) || [];
            return events;
        };

        strikeChart.options.plugins.tooltip.displayColors = false;
        strikeChart.options.plugins.legend.display = false;

        if (interval === 'month') {
            strikeChart.options.scales.x.time.unit = 'month';
            strikeChart.options.scales.x.time.displayFormats = {
                month: 'MMMM yyyy'
            };
        } else if (interval === 'week') {
            strikeChart.options.scales.x.time.unit = 'day';
            strikeChart.options.scales.x.time.displayFormats = {
                day: 'PP'
            };
        } else {
            strikeChart.options.scales.x.time.unit = 'day';
            strikeChart.options.scales.x.time.displayFormats = {
                day: 'PP'
            };
        }

        strikeChart.update();
    }

    function toggleFilterItem(event) {
        event.target.classList.toggle('active');
        updateChart(window.strikeData);
    }

    let strikeChart;
    document.addEventListener('DOMContentLoaded', async () => {
        const startDate = new Date();
        const urls = getPastDatesUrls(startDate, 12*5);
        const data = await fetchDataFromUrls(urls);

        if (data) {
            window.strikeData = data;

            initFilters(data);

            const ctx = document.getElementById('strikeChart').getContext('2d');
            strikeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Число новостей о забастовках',
                        data: [],
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'week',
                                tooltipFormat: 'PP'
                            },
                            title: {
                                display: false,
                                text: 'Date'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Число новостей о забастовках'
                            }
                        }
                    }
                }
            });

            document.getElementById('intervalSelect').addEventListener('change', () => updateChart(data));
            updateChart(data);
        }
    });
</script>
</body>
</html>